<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Admin Panel</title>
    <!-- CSS Libraries සහ Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Parse SDK -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>

    <style>
        /* General App Styles */
        :root { --primary-color: #29abe2; --success-color: #28a745; --danger-color: #dc3545; --dark-color: #1e2a39; --light-gray: #f0f2f5; --purple-color: #6f42c1; --blue-color: #007bff; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--light-gray); margin: 0; padding: 0; color: #333; }
        main { padding: 20px; display: flex; justify-content: center; }
        .app-header { background-color: var(--dark-color); padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .navbar { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; height: 60px; }
        .navbar-brand { color: #fff; font-size: 22px; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 12px; }
        .navbar-logo { height: 40px; width: auto; }
        .nav-links { margin-left: auto; display: flex; gap: 10px; }
        .nav-links button { background: none; border: none; color: #c1d1e8; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px; transition: background-color .3s,color .3s; }
        .nav-links button:hover, .nav-links button.active { background-color: var(--primary-color); color: #fff; }
        .page-content { display: none; width: 100%;}
        .container { max-width: 700px; width: 100%; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); box-sizing: border-box; }
        h1, h2 { text-align: center; color: var(--dark-color); }
        h1 { margin-top: 0; margin-bottom: 25px; }
        h2 { font-size: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        h3 { font-size: 18px; color: #333; margin-top: 25px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; background-color: var(--primary-color); color: #fff; }
        
        .submit-btn, .action-row button, .btn { 
            background-color: var(--primary-color);
        }

        .btn-secondary { background-color: #6c757d; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color:#6c757d; cursor:not-allowed; }
        .message { text-align: center; margin-top: 15px; font-weight: 500; padding: 10px; border-radius: 5px; display: none; }
        .message.success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .message.error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        hr { border: 0; height: 1px; background-color: #e9ecef; margin: 30px 0; }
        .form-group .error-text{ color: var(--danger-color); font-size:12px; margin-top:4px; min-height:1em; }
        #accounts-list, #promo-list-pc { list-style: none; padding: 0; margin: 0; }
        .account-card { background:#f8f9fa; padding:15px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,.05); margin-bottom: 10px; border-left: 5px solid; transition: border-color 0.3s; }
        .account-card.status-active { border-left-color: var(--blue-color); }
        .account-card.status-inactive { border-left-color: var(--purple-color); }
        .account-card-info { flex-grow: 1; }
        .account-card-controls { display: flex; align-items: center; gap: 15px; }
        .edit-details-btn { font-size: 20px; color: #6c757d; cursor: pointer; } .edit-details-btn:hover { color: #007bff; }
        .delete-btn { font-size: 18px; color: var(--danger-color); cursor: pointer; background: none; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--blue-color); }
        input:not(:checked) + .slider { background-color: var(--purple-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,.6); }
        .modal-content { background-color:#fefefe; margin:10% auto; padding:20px; border:1px solid #888; width:90%; max-width:500px; border-radius:8px; position:relative; }
        .close-btn { color:#aaa; position:absolute; top:10px; right:20px; font-size:28px; font-weight:700; cursor:pointer; }
        #search-container { position:relative; } #search-container .fa-search { position:absolute; left:15px; top:15px; color:#6c757d; }
        #search-input { padding-left: 40px; }
        .search-section, .update-section, .section { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .section:last-child { border-bottom: none; }
        .action-row { display: flex; align-items: center; gap: 10px; }
        .action-row select { width: 120px; } .action-row input { flex-grow: 1; }

        #player-id-list-container-dc ul { list-style: none; padding: 0; margin-top: 15px; }
        #player-id-list-container-dc li { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #e9ecef; }
        .delete-player-id-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0 5px; font-size: 16px; width: auto; }
        .delete-player-id-btn:hover { opacity: 0.7; }
        
        @media (max-width: 768px) {
            body, main { padding: 0; }
            .container { padding: 20px 15px; box-shadow: none; border-radius: 0; min-height: calc(100vh - 120px); }
            .navbar { flex-direction: column; height: auto; padding: 10px 0; }
            .nav-links { margin-left: 0; margin-top: 10px; width: 100%; justify-content: center; flex-wrap: wrap; }
            .nav-links button { font-size: 13px; padding: 8px 10px; }
            .action-row, .account-card-controls { flex-wrap: wrap; gap: 8px; }
            h1 { font-size: 24px; } h2 { font-size: 18px; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <nav class="navbar">
            <a href="#" class="navbar-brand">
                <img src="https://i.postimg.cc/0jwDg51t/1001086315.png" alt="Admin Logo" class="navbar-logo">
                <span>Admin Panel</span>
            </a>
            <div class="nav-links">
                <button class="nav-btn active" data-page="page-partners">Partner Accounts</button>
                <button class="nav-btn" data-page="page-data-control">Data Control</button>
                <button class="nav-btn" data-page="page-promo-codes">Promo Codes</button>
            </div>
        </nav>
    </header>

    <main id="app-content">
        <!-- PAGE 1: Partner Accounts -->
        <div id="page-partners" class="page-content" style="display: block;">
             <div class="container">
                <h1>Partner Account Activation</h1>
                <div id="success-message-partners" class="message"></div>
                <form id="activation-form">
                    <div class="form-group"><label for="aff-id">Aff ID (Username)</label><input type="text" id="aff-id" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="first-name">First Name</label><input type="text" id="first-name" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="last-name">Last Name</label><input type="text" id="last-name" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="email">Email</label><input type="email" id="email" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="phone">Phone Number</label><input type="tel" id="phone" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="commission">Commission (%)</label><input type="number" id="commission" step="0.01" required><small class="error-text"></small></div>
                    <div class="form-group"><label for="promo-code">Promo Code</label><input type="text" id="promo-code" required><small class="error-text"></small></div>
                    <button type="submit" class="submit-btn">Activate Account</button>
                </form>
                <hr>
                <h2>Activated Accounts</h2>
                <div id="search-container">
                     <i class="fas fa-search"></i>
                     <input type="text" id="search-input" placeholder="Search by Aff ID...">
                </div>
                <div id="accounts-list" style="margin-top: 20px;"></div>
            </div>
            <div id="edit-modal" class="modal">
              <div class="modal-content">
                <span class="close-btn">×</span>
                <div id="modal-body"></div>
              </div>
            </div>
        </div>

        <!-- PAGE 2: Data Control -->
        <div id="page-data-control" class="page-content">
            <div class="container">
                <h1>Admin Control Panel</h1>
                <div class="search-section"><div class="form-group"><label for="aff-id-input-dc">Affiliate ID</label><input type="text" id="aff-id-input-dc" placeholder="Enter Aff ID to search"></div><button id="search-btn-dc" class="btn">Search User</button></div>
                <div id="update-form-container-dc" style="display: none;">
                    <div id="user-info-dc" class="message" style="background: none; color: var(--primary-color); font-weight: bold; font-size: 18px;"></div>
                    <div class="update-section">
                        <div class="update-row"><label>Registrations</label><div class="action-row"><input type="number" id="registrations-input-dc" placeholder="Set new value"><button class="update-btn" data-field="registrations" data-input="registrations-input-dc">Update</button></div></div>
                        <div class="update-row"><label>Registrations with deposits</label><div class="action-row"><input type="number" id="reg-deposits-input-dc" placeholder="Set new value"><button class="update-btn" data-field="regWithDeposits" data-input="reg-deposits-input-dc">Update</button></div></div>
                        
                        <!-- *** අලුතින් එකතු කළ කොටස් *** -->
                        <div class="update-row"><label>Available to Withdraw ($)</label><div class="action-row"><input type="number" step="0.01" id="available-withdrawal-input-dc" placeholder="Set new value"><button class="update-btn" data-field="availableWithdrawal" data-input="available-withdrawal-input-dc">Update</button></div></div>
                        <div class="update-row"><label>Yesterday Earnings ($)</label><div class="action-row"><input type="number" step="0.01" id="yesterday-earnings-input-dc" placeholder="Set new value"><button class="update-btn" data-field="yesterdayEarnings" data-input="yesterday-earnings-input-dc">Update</button></div></div>
                        <!-- *************************** -->

                        <div class="update-row"><label>Update Profit</label><div class="action-row"><select id="profit-op-select-dc"><option value="add">Add (+)</option><option value="subtract">Subtract (-)</option></select><input type="number" id="profit-amount-input-dc" placeholder="Amount"><button id="profit-update-btn-dc">Update</button></div></div>
                    </div>
                    
                    <div class="update-section">
                        <h3>Manage Player IDs</h3>
                        <div class="action-row">
                            <input type="text" id="player-id-input-dc" placeholder="Enter new Player ID">
                            <button id="add-player-id-btn-dc" style="width: 150px;">Add Player ID</button>
                        </div>
                        <div id="player-id-list-container-dc" style="margin-top: 15px;"></div>
                    </div>

                </div>
                <div id="status-message-dc" class="message"></div>
            </div>
        </div>

        <!-- PAGE 3: Promo Codes -->
        <div id="page-promo-codes" class="page-content">
            <div class="container">
                <h1>Promo Code Admin Panel</h1>
                <div class="section"><h2>Add New Promo Code</h2><form id="add-promo-form"><div class="form-group"><label for="add-aff-id-pc">Partner AFF ID</label><input type="text" id="add-aff-id-pc" placeholder="e.g., 123456" required></div><div class="form-group"><label for="add-promo-code-pc">New Promo Code</label><input type="text" id="add-promo-code-pc" placeholder="e.g., MYPROMO25" required></div><button type="submit" class="btn">Add Promo Code</button></form><p id="add-message-box-pc" class="message"></p></div>
                <div class="section"><h2>Manage Existing Promo Codes</h2><form id="search-promo-form"><div class="form-group"><label for="search-aff-id-pc">Search by AFF ID</label><input type="text" id="search-aff-id-pc" placeholder="Enter AFF ID to find codes" required></div><button type="submit" class="btn btn-secondary">Search Promo Codes</button></form><p id="search-message-box-pc" class="message"></p><div id="promo-list-container-pc" style="display:none;"><h3>Codes for AFF ID: <span id="user-info-pc"></span></h3><ul id="promo-list-pc"></ul></div></div>
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. GLOBAL SETUP ---
        const APP_ID = "JcbmnFqsJrlJpCTG2yoO8LfmgaPWNJkITMDQQ1Rj";
        const JS_KEY = "V9nyLXqEWh6AGuq5zHx81YkXRz3X4VwUwnVO3T56";
        Parse.initialize(APP_ID, JS_KEY);
        Parse.serverURL = 'https://parseapi.back4app.com';
        const PartnerAccount = Parse.Object.extend("PartnerAccount");

        // --- 2. NAVIGATION (TAB) LOGIC ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');
        navButtons.forEach(button => { button.addEventListener('click', () => { pages.forEach(page => page.style.display = 'none'); navButtons.forEach(btn => btn.classList.remove('active')); document.getElementById(button.getAttribute('data-page')).style.display = 'block'; button.classList.add('active'); }); });

        // --- 3. PAGE-SPECIFIC JAVASCRIPT SETUP ---
        function setupPartnersPage() {
            const page = document.getElementById('page-partners'); if (!page) return;
            const activationForm = page.querySelector('#activation-form'), accountsList = page.querySelector('#accounts-list'), searchInput = page.querySelector('#search-input'), modal = page.querySelector('#edit-modal'), modalBody = page.querySelector('#modal-body'), closeModalBtn = page.querySelector('.close-btn'), successMsg = page.querySelector('#success-message-partners');
            let allAccounts = [];
            const showMessage = (text, type = 'success') => { successMsg.textContent = text; successMsg.className = `message ${type}`; successMsg.style.display = 'block'; setTimeout(() => { successMsg.style.display = 'none' }, 4000); };
            async function fetchAndRenderAccounts() { accountsList.innerHTML = '<p>Loading accounts...</p>'; try { const results = await new Parse.Query(PartnerAccount).descending("createdAt").find(); allAccounts = results; displayAccounts(results); } catch (error) { showMessage('Could not load accounts.', 'error'); } }
            function displayAccounts(accountsToDisplay) { accountsList.innerHTML = accountsToDisplay.length === 0 ? '<p>No accounts found.</p>' : ''; accountsToDisplay.forEach(account => { const card = document.createElement('div'); card.className = 'account-card'; const status = account.get('accountStatus') || 'inactive'; card.classList.add(status === 'active' ? 'status-active' : 'status-inactive'); const isChecked = status === 'active' ? 'checked' : ''; card.innerHTML = `<div class="account-card-info"><strong>Aff ID: ${account.get('affId')}</strong><br><span>Commission: ${account.get('commission')}%</span></div><div class="account-card-controls"><label class="switch" title="Toggle Status (Purple: Inactive, Blue: Active)"><input type="checkbox" class="status-toggle" data-id="${account.id}" ${isChecked}><span class="slider"></span></label><i class="fas fa-edit edit-details-btn" data-id="${account.id}" title="Edit Details"></i></div>`; accountsList.appendChild(card); }); }
            activationForm.addEventListener('submit', async (e) => { e.preventDefault(); const submitBtn = e.target.querySelector('button'); submitBtn.disabled = true; submitBtn.textContent = 'Activating...'; activationForm.querySelectorAll('.error-text').forEach(el => el.textContent = ''); const data = { affId: activationForm.querySelector('#aff-id').value.trim(), password: activationForm.querySelector('#password').value, firstName: activationForm.querySelector('#first-name').value.trim(), lastName: activationForm.querySelector('#last-name').value.trim(), email: activationForm.querySelector('#email').value.trim(), phone: activationForm.querySelector('#phone').value.trim(), commission: parseFloat(activationForm.querySelector('#commission').value), promoCode: activationForm.querySelector('#promo-code').value.trim(), accountStatus: 'inactive' }; try { await new PartnerAccount().save(data); showMessage(`Account for ${data.affId} activated successfully!`, 'success'); activationForm.reset(); fetchAndRenderAccounts(); } catch(error) { showMessage('Error activating account: ' + error.message, 'error'); } finally { submitBtn.disabled = false; submitBtn.textContent = 'Activate Account'; } });
            searchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); const filtered = allAccounts.filter(acc => acc.get('affId').toLowerCase().includes(searchTerm)); displayAccounts(filtered); });
            accountsList.addEventListener('change', async (e) => { if (e.target.classList.contains('status-toggle')) { const toggle = e.target; const accountId = toggle.getAttribute('data-id'); const newStatus = toggle.checked ? 'active' : 'inactive'; const card = toggle.closest('.account-card'); card.classList.remove('status-active', 'status-inactive'); card.classList.add(newStatus === 'active' ? 'status-active' : 'status-inactive'); try { const accountToUpdate = new Parse.Object("PartnerAccount"); accountToUpdate.id = accountId; accountToUpdate.set('accountStatus', newStatus); await accountToUpdate.save(); showMessage(`Status updated to ${newStatus}.`, 'success'); } catch (error) { showMessage('Failed to update status.', 'error'); toggle.checked = !toggle.checked; card.classList.remove('status-active', 'status-inactive'); card.classList.add(newStatus === 'active' ? 'status-inactive' : 'status-active'); } } });
            accountsList.addEventListener('click', (e) => { if (e.target.closest('.edit-details-btn')) { const account = allAccounts.find(acc => acc.id === e.target.closest('.edit-details-btn').getAttribute('data-id')); if(account) showEditModal(account); } });
            function showEditModal(account) { modalBody.innerHTML = `<form id="edit-form" data-id="${account.id}" novalidate><h3>Edit Account: ${account.get('affId')}</h3><div class="form-group"><label>Password</label><input type="text" id="edit-password" value="${account.get('password') || ''}" required><small class="error-text"></small></div><div class="form-group"><label>First Name</label><input type="text" id="edit-first-name" value="${account.get('firstName') || ''}" required><small class="error-text"></small></div><div class="form-group"><label>Last Name</label><input type="text" id="edit-last-name" value="${account.get('lastName') || ''}" required><small class="error-text"></small></div><div class="form-group"><label>Email</label><input type="email" id="edit-email" value="${account.get('email') || ''}" required><small class="error-text"></small></div><div class="form-group"><label>Phone</label><input type="tel" id="edit-phone" value="${account.get('phone') || ''}" required><small class="error-text"></small></div><div class="form-group"><label>Commission (%)</label><input type="number" id="edit-commission" value="${account.get('commission') || 0}" step="0.01" required><small class="error-text"></small></div><div class="form-group"><label>Promo Code</label><input type="text" id="edit-promo-code" value="${account.get('promoCode') || ''}" required><small class="error-text"></small></div><div class="modal-buttons"><button type="submit" id="save-changes-btn" class="submit-btn">Save Changes</button></div></form>`; modal.style.display = 'block'; }
            modal.addEventListener('submit', async (e) => { if (e.target.id === 'edit-form') { e.preventDefault(); const form = e.target; const saveBtn = form.querySelector('#save-changes-btn'); saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; form.querySelectorAll('.error-text').forEach(el => el.textContent = ''); const accountId = form.getAttribute('data-id'); const newValues = { password: form.querySelector('#edit-password').value, firstName: form.querySelector('#edit-first-name').value.trim(), lastName: form.querySelector('#edit-last-name').value.trim(), email: form.querySelector('#edit-email').value.trim(), phone: form.querySelector('#edit-phone').value.trim(), commission: parseFloat(form.querySelector('#edit-commission').value), promoCode: form.querySelector('#edit-promo-code').value.trim() }; const orQuery = Parse.Query.or(new Parse.Query(PartnerAccount).equalTo("email", newValues.email), new Parse.Query(PartnerAccount).equalTo("phone", newValues.phone), new Parse.Query(PartnerAccount).equalTo("promoCode", newValues.promoCode)); orQuery.notEqualTo("objectId", accountId); let hasError = false; try { const duplicates = await orQuery.find(); if (duplicates.length > 0) { duplicates.forEach(dup => { if (dup.get('email') === newValues.email) { form.querySelector('#edit-email').nextElementSibling.textContent = 'Already in use'; hasError = true; } if (dup.get('phone') === newValues.phone) { form.querySelector('#edit-phone').nextElementSibling.textContent = 'Already in use'; hasError = true; } if (dup.get('promoCode') === newValues.promoCode) { form.querySelector('#edit-promo-code').nextElementSibling.textContent = 'Already in use'; hasError = true; } }); } if (hasError) throw new Error("Duplicate values found."); const accountToUpdate = await new Parse.Query(PartnerAccount).get(accountId); for (const key in newValues) { accountToUpdate.set(key, newValues[key]); } await accountToUpdate.save(); modal.style.display = 'none'; showMessage('Account updated successfully!', 'success'); await fetchAndRenderAccounts(); } catch (error) { showMessage('Error: ' + error.message, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; } } });
            closeModalBtn.onclick = () => { modal.style.display = 'none'; }; window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; } });
            fetchAndRenderAccounts();
        }
        
        function setupDataControlPage() {
            const page = document.getElementById('page-data-control'); if(!page) return;
            let currentUserObject = null;
            const searchBtn = page.querySelector('#search-btn-dc'), affIdInput = page.querySelector('#aff-id-input-dc'), updateFormContainer = page.querySelector('#update-form-container-dc'), userInfo = page.querySelector('#user-info-dc'), statusMessage = page.querySelector('#status-message-dc');
            const addPlayerIdBtn = page.querySelector('#add-player-id-btn-dc'), playerIdInput = page.querySelector('#player-id-input-dc'), playerIdListContainer = page.querySelector('#player-id-list-container-dc');
            
            const showStatus = (message, isError = false) => { statusMessage.textContent = message; statusMessage.className = `message ${isError ? 'error' : 'success'}`; statusMessage.style.display = 'block'; setTimeout(() => { statusMessage.style.display = 'none'; }, 4000); };
            
            function displayPlayerIds(ids) {
                playerIdListContainer.innerHTML = '';
                const ul = document.createElement('ul');
                if (ids && ids.length > 0) {
                    ids.forEach(id => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${id}</span><button class="delete-player-id-btn" data-id="${id}"><i class="fas fa-trash-alt"></i></button>`;
                        ul.appendChild(li);
                    });
                } else {
                    ul.innerHTML = '<li>No Player IDs found for this account.</li>';
                }
                playerIdListContainer.appendChild(ul);
            }

            searchBtn.addEventListener('click', async () => { 
                const affId = affIdInput.value.trim(); 
                if (!affId) return showStatus("Please enter an Affiliate ID.", true); 
                try { 
                    const user = await new Parse.Query(PartnerAccount).equalTo("affId", affId).first(); 
                    if (user) { 
                        currentUserObject = user; 
                        userInfo.textContent = `Editing: ${user.get('firstName') || ''} (ID: ${user.get('affId')})`; 
                        userInfo.style.display = 'block'; 
                        
                        // *** අලුත් සහ පරණ සියලුම Fields වලට දත්ත ලබා දීම ***
                        page.querySelector('#registrations-input-dc').value = user.get('registrations') || 0; 
                        page.querySelector('#reg-deposits-input-dc').value = user.get('regWithDeposits') || 0; 
                        page.querySelector('#available-withdrawal-input-dc').value = user.get('availableWithdrawal') || 0;
                        page.querySelector('#yesterday-earnings-input-dc').value = user.get('yesterdayEarnings') || 0;
                        page.querySelector('#profit-amount-input-dc').value = ''; 
                        
                        updateFormContainer.style.display = 'block'; 
                        displayPlayerIds(user.get('playerIds'));
                        showStatus("User found.", false); 
                    } else { 
                        updateFormContainer.style.display = 'none'; 
                        currentUserObject = null;
                        showStatus("No user found with that Affiliate ID.", true); 
                    } 
                } catch (error) { 
                    showStatus("An error occurred during search.", true); 
                } 
            });

            // මෙම function එක කිසිදු වෙනසක් නොමැතිව "Available to Withdraw" සහ "Yesterday" සඳහා ද ක්‍රියා කරයි.
            page.querySelectorAll('.update-btn').forEach(button => { 
                button.addEventListener('click', async (e) => { 
                    if (!currentUserObject) return showStatus("Please search for a user first.", true); 
                    const field = e.target.getAttribute('data-field'); 
                    const value = parseFloat(page.querySelector(`#${e.target.getAttribute('data-input')}`).value); 
                    if (isNaN(value)) return showStatus("Please enter a valid number.", true); 
                    currentUserObject.set(field, value); 
                    try { 
                        await currentUserObject.save(); 
                        showStatus(`'${field}' updated successfully!`, false); 
                    } catch (error) { 
                        showStatus(`Failed to update '${field}'.`, true); 
                    } 
                }); 
            });
            
            page.querySelector('#profit-update-btn-dc').addEventListener('click', async () => { if (!currentUserObject) return showStatus("Please search for a user first.", true); let amount = parseFloat(page.querySelector('#profit-amount-input-dc').value); if (isNaN(amount)) return showStatus("Please enter a valid amount.", true); if (page.querySelector('#profit-op-select-dc').value === 'subtract') amount = -amount; currentUserObject.increment('profit', amount); try { await currentUserObject.save(); showStatus(`Profit updated successfully!`, false); page.querySelector('#profit-amount-input-dc').value = ''; } catch (error) { showStatus(`Failed to update profit.`, true); } });
            
            addPlayerIdBtn.addEventListener('click', async () => {
                if (!currentUserObject) return showStatus("Please search for a user first.", true);
                const newPlayerId = playerIdInput.value.trim();
                if (!newPlayerId) return showStatus("Please enter a Player ID.", true);
                currentUserObject.addUnique("playerIds", newPlayerId);
                try { await currentUserObject.save(); showStatus(`Player ID "${newPlayerId}" added successfully!`, false); playerIdInput.value = ''; displayPlayerIds(currentUserObject.get('playerIds')); } catch (error) { showStatus(`Failed to add Player ID. Error: ${error.message}`, true); }
            });

            playerIdListContainer.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.delete-player-id-btn');
                if (!deleteButton) return;
                if (!currentUserObject) return showStatus("Current user not found.", true);
                const idToDelete = deleteButton.getAttribute('data-id');
                if (confirm(`Are you sure you want to delete Player ID: ${idToDelete}?`)) {
                    currentUserObject.remove("playerIds", idToDelete);
                    try { await currentUserObject.save(); showStatus(`Player ID "${idToDelete}" removed successfully.`, false); displayPlayerIds(currentUserObject.get('playerIds')); } catch (error) { showStatus(`Failed to remove Player ID. Error: ${error.message}`, true); }
                }
            });
        }

        function setupPromoCodesPage() {
            const page = document.getElementById('page-promo-codes'); if(!page) return;
            const addForm = page.querySelector('#add-promo-form'), searchForm = page.querySelector('#search-promo-form'), addMessageBox = page.querySelector('#add-message-box-pc'), searchMessageBox = page.querySelector('#search-message-box-pc'), promoListContainer = page.querySelector('#promo-list-container-pc'), promoListUl = page.querySelector('#promo-list-pc'), userInfoSpan = page.querySelector('#user-info-pc');
            let currentPartner = null;
            const showMessage = (element, text, type) => { element.textContent = text; element.className = `message ${type}`; element.style.display = 'block'; if (type !== 'clear') setTimeout(() => { element.style.display = 'none'; }, 4000); };
            addForm.addEventListener('submit', async (e) => { e.preventDefault(); const affId = page.querySelector('#add-aff-id-pc').value.trim(); const newPromoCode = page.querySelector('#add-promo-code-pc').value.trim().toUpperCase(); if (!affId || !newPromoCode) return showMessage(addMessageBox, 'Aff ID and Promo Code are required.', 'error'); try { const count = await new Parse.Query(PartnerAccount).equalTo("promoCodes", newPromoCode).count(); if (count > 0) return showMessage(addMessageBox, 'This promo code is already in use.', 'error'); const partner = await new Parse.Query(PartnerAccount).equalTo("affId", affId).first(); if (!partner) return showMessage(addMessageBox, 'No account found with this Aff ID.', 'error'); partner.addUnique("promoCodes", newPromoCode); await partner.save(); showMessage(addMessageBox, 'Promo code added successfully!', 'success'); addForm.reset(); } catch (error) { showMessage(addMessageBox, 'An error occurred.', 'error'); } });
            searchForm.addEventListener('submit', async (e) => { e.preventDefault(); const affId = page.querySelector('#search-aff-id-pc').value.trim(); if (!affId) return showMessage(searchMessageBox, 'Please enter an Aff ID to search.', 'error'); try { const partner = await new Parse.Query(PartnerAccount).equalTo("affId", affId).first(); if (!partner) { promoListContainer.style.display = 'none'; return showMessage(searchMessageBox, 'No account found.', 'error'); } currentPartner = partner; userInfoSpan.textContent = partner.get('affId'); displayPromoCodes(partner.get('promoCodes')); } catch (error) { showMessage(searchMessageBox, 'An error occurred during search.', 'error'); } });
            function displayPromoCodes(codes) { promoListUl.innerHTML = (codes && codes.length > 0) ? '' : '<li>No promo codes found.</li>'; if (codes) { codes.forEach(code => { const li = document.createElement('li'); li.innerHTML = `<span>${code}</span><button class="delete-btn" data-code="${code}"><i class="fas fa-trash-alt"></i></button>`; promoListUl.appendChild(li); }); } promoListContainer.style.display = 'block'; promoListUl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete)); }
            async function handleDelete(e) { const codeToDelete = e.currentTarget.getAttribute('data-code'); if (!currentPartner || !confirm(`Delete "${codeToDelete}"?`)) return; currentPartner.remove("promoCodes", codeToDelete); try { await currentPartner.save(); showMessage(searchMessageBox, `"${codeToDelete}" was deleted.`, 'success'); displayPromoCodes(currentPartner.get('promoCodes')); } catch (error) { showMessage(searchMessageBox, 'Failed to delete.', 'error'); } }
        }
        setupPartnersPage();
        setupDataControlPage();
        setupPromoCodesPage();
    });
    </script>
</body>
</html>
